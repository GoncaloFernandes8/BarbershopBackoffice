<div class="calendar-page">
  <div class="calendar-header">
    <div class="header-top">
      <h1>Calendário</h1>
      <button class="header-button primary-button" (click)="onCreateAppointment()" [disabled]="!selectedDate && viewMode === 'month'">
        <mat-icon>add</mat-icon>
        <span>Nova Marcação</span>
      </button>
    </div>
    
    <div class="calendar-controls">
      <!-- Filtro Barbeiro -->
      <div class="control-item">
        <label class="control-label">Barbeiro</label>
        <div class="custom-select">
          <select [(ngModel)]="selectedBarber" (change)="onBarberChange()" class="select-input">
            <option value="all">Todos os barbeiros</option>
            <option *ngFor="let barber of barbers" [value]="barber.id">
              {{ barber.name }}
            </option>
          </select>
          <mat-icon class="select-icon">expand_more</mat-icon>
        </div>
      </div>

      <!-- Filtro Estado -->
      <div class="control-item">
        <label class="control-label">Estado</label>
        <div class="custom-select">
          <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="select-input">
            <option value="all">Todas as marcações</option>
            <option value="active">Marcações ativas</option>
            <option value="cancelled">Marcações canceladas</option>
          </select>
          <mat-icon class="select-icon">expand_more</mat-icon>
        </div>
      </div>

      <!-- Botão Vista -->
      <button class="header-button" (click)="toggleViewMode()">
        <mat-icon>{{ viewMode === 'month' ? 'calendar_view_day' : 'calendar_view_month' }}</mat-icon>
        <span>{{ viewMode === 'month' ? 'Vista Diária' : 'Vista Mensal' }}</span>
      </button>

      <!-- Navegação -->
      <div class="navigation-control">
        <button class="nav-button" (click)="viewMode === 'month' ? onPreviousMonth() : onPreviousDay()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="nav-date">{{ viewMode === 'month' ? getMonthYear() : getDayViewDateFormatted() }}</span>
        <button class="nav-button" (click)="viewMode === 'month' ? onNextMonth() : onNextDay()">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Vista Mensal -->
  <div class="calendar-container" *ngIf="viewMode === 'month'">
    <div class="calendar-grid">
      <!-- Cabeçalho dos dias da semana -->
      <div class="weekday-header" *ngFor="let day of weekDays">
        {{ day }}
      </div>

      <!-- Dias do calendário -->
      <div 
        class="calendar-day" 
        *ngFor="let day of calendarDays"
        [class.today]="isToday(day)"
        [class.selected]="isSelected(day)"
        [class.other-month]="!isSameMonth(day, currentDate)"
        [class.has-appointments]="getAppointmentsForDate(day).length > 0"
        (click)="onDateClick(day)"
      >
        <div class="day-number">{{ day.getDate() }}</div>
        
        <div class="appointments-list">
          <div 
            class="appointment-chip"
            *ngFor="let appointment of getAppointmentsForDate(day)"
            [class]="'status-' + getStatusColor(appointment.status)"
            [title]="appointment.notes || ''"
          >
            <span class="time">{{ formatTime(appointment.startsAt) }}</span>
            <span class="service">{{ getServiceName(appointment.serviceId) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Diária -->
  <div class="day-view-container" *ngIf="viewMode === 'day'">
    <div class="day-view-timeline">
      <!-- Grid de horários (slots de 30 minutos) -->
      <div class="timeline-slot" *ngFor="let slot of dayViewTimeSlots">
        <div class="slot-label">
          {{ slot }}
        </div>
        <div class="slot-line"></div>
      </div>

      <!-- Container para marcações com posicionamento absoluto -->
      <div class="appointments-container">
        <div 
          class="day-appointment"
          *ngFor="let appointment of getAllAppointmentsForDay()"
          [class]="'status-' + getStatusColor(appointment.status)"
          [style.top.px]="getAppointmentTopPosition(appointment)"
          [style.height.px]="getAppointmentHeight(appointment)"
          [title]="appointment.notes || ''"
        >
          <div class="appointment-time-range">
            {{ formatTime(appointment.startsAt) }} - {{ formatTime(appointment.endsAt) }}
          </div>
          <div class="appointment-service">
            {{ getServiceName(appointment.serviceId) }}
          </div>
          <div class="appointment-client">
            {{ getClientName(appointment.clientId) }}
          </div>
          <div class="appointment-barber" *ngIf="selectedBarber === 'all'">
            <mat-icon>person</mat-icon>
            {{ getBarberName(appointment.barberId) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Painel lateral com detalhes da data selecionada -->
  <div class="selected-date-panel" *ngIf="selectedDate">
    <div class="panel-header">
      <h3>{{ format(selectedDate, 'dd/MM/yyyy') }}</h3>
      <button mat-icon-button (click)="selectedDate = null">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="appointments-list">
      <div 
        class="appointment-card"
        *ngFor="let appointment of getAppointmentsForDate(selectedDate)"
      >
        <div class="appointment-time">
          {{ formatTime(appointment.startsAt) }} - {{ formatTime(appointment.endsAt) }}
        </div>
        <div class="appointment-details">
          <div class="service-name">{{ getServiceName(appointment.serviceId) }}</div>
          <div class="client-name">{{ getClientName(appointment.clientId) }}</div>
          <div class="barber-name" *ngIf="selectedBarber === 'all'">
            <mat-icon>person</mat-icon>
            {{ getBarberName(appointment.barberId) }}
          </div>
          <div class="appointment-status">
            <mat-chip [class]="'status-' + getStatusColor(appointment.status)">
              {{ appointment.status }}
            </mat-chip>
          </div>
        </div>
        <div class="appointment-notes" *ngIf="appointment.notes">
          {{ appointment.notes }}
        </div>
      </div>

      <div class="no-appointments" *ngIf="getAppointmentsForDate(selectedDate).length === 0">
        <p>Nenhuma marcação para este dia</p>
        <button mat-button color="primary" (click)="onCreateAppointment()">
          <mat-icon>add</mat-icon>
          Criar Marcação
        </button>
      </div>
    </div>
  </div>
</div>
